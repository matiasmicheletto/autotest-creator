window.middleware=function(){var o={apiKey:"AIzaSyDcBhhiu-dQXWaGBLcTEtnz8HPnelfXuA4",authDomain:"covid19-autotest.firebaseapp.com",databaseURL:"https://covid19-autotest.firebaseio.com",projectId:"covid19-autotest",storageBucket:"covid19-autotest.appspot.com",messagingSenderId:"541298094681",appId:"1:541298094681:web:a715a3322843f6ff7e7748",measurementId:"G-0YZX1RVB1F"},t=!0,n={},e={};return n.init=function(){return new Promise(function(i,a){try{firebase.initializeApp(o);var c=function(){t&&console.log("Recurso de configuracion: hosting"),$.getJSON("custom/config.json",i,function(o){return a(o)})},r=function(){n.db.get("config").then(function(o){o?(e.config=o,e.configTimestamp=Date.now(),t&&console.log("Recurso de configuracion: DB"),i(o)):c()})["catch"](function(o){t&&console.log(o),c()})};e.config&&Date.now()-e.configTimestamp<36e5?(t&&console.log("Recurso de configuracion: cache"),i(e.config)):r()}catch(u){return a(u)}})},n.getTree=function(){return new Promise(function(o,e){var i=function(){$.getJSON("custom/tree.json",function(n){return t&&console.log(n),o(n)},function(o){return e(o)})};n.db.query("decisionTrees","active",!0).then(function(n){n.forEach(function(n){return t&&console.log(n.val()),o(n.val())})})["catch"](function(o){t&&console.log(o),i()})})},n.checkLocation=function(o){return new Promise(function(n,e){return navigator.geolocation?void navigator.geolocation.getCurrentPosition(function(i){var a=function(o,t){const n=6378.137,e=t.lat*Math.PI/180-o.lat*Math.PI/180,i=t.lng*Math.PI/180-o.lng*Math.PI/180,a=Math.sin(e/2)*Math.sin(e/2)+Math.cos(o.lat*Math.PI/180)*Math.cos(t.lat*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 2*n*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))},c={lat:i.coords.latitude,lng:i.coords.longitude},r=a(o.locationFilter,c);return t&&(console.log("Filtro: Lat.: "+i.coords.latitude+" -- Lng: "+i.coords.longitude),console.log("Cliente: Lat: "+o.locationFilter.lat+" -- Lng: "+o.locationFilter.lng),console.log("Distancia: "+r)),r<o.locationFilter.range?n({lat:i.coords.latitude,lng:i.coords.longitude}):e({msg:"Usuario fuera de area"})}):e({msg:"No se pudo determinar ubicación."})})},n}();
!function(n){n.db={},n.db.listen=function(n,e,t){firebase.database().ref(n).on("value",function(n){e(n.val(),n.key)},function(n){t(n)})},n.db.listenChild=function(n,e,t,r,u){firebase.database().ref(n).orderByChild(e).equalTo(t).on("child_added",function(n){r(n.val(),n.key)},function(n){u(n)})},n.db.stopListener=function(n){return new Promise(function(e,t){firebase.database().ref(n).off().then(function(){return e()})["catch"](function(n){return t(n)})})},n.db.get=function(n){return new Promise(function(e,t){firebase.database().ref(n).once("value").then(function(n){return e(n.val())})["catch"](function(n){return t(n)})})},n.db.getSorted=function(n,e){return new Promise(function(t,r){firebase.database().ref(n).orderByChild(e).once("value").then(function(n){return t(n)})["catch"](function(n){return r(n)})})},n.db.getSortedLimited=function(n,e,t){return new Promise(function(r,u){firebase.database().ref(n).orderByChild(e).limitToLast(t).once("value").then(function(n){return r(n)})["catch"](function(n){return u(n)})})},n.db.query=function(n,e,t){return new Promise(function(r,u){firebase.database().ref(n).orderByChild(e).equalTo(t).once("value").then(function(n){return r(n)})["catch"](function(n){return u(n)})})},n.db.set=function(n,e){return new Promise(function(t,r){firebase.database().ref(e).set(n).then(function(n){return t(n)})["catch"](function(n){return r(n)})})},n.db.update=function(n,e){return new Promise(function(t,r){firebase.database().ref(e).update(n).then(function(n){return t(n)})["catch"](function(n){return r(n)})})},n.db.push=function(n,e){return new Promise(function(t,r){firebase.database().ref(e).push(n).then(function(n){return t(n)})["catch"](function(n){return r(n)})})},n.db.pushMultiple=function(n,e){return new Promise(function(t,r){var u=[];for(var i in n)u.push(firebase.database().ref(e).push(n[i]));Promise.all(u).then(function(n){return t(n)})["catch"](function(n){return r(n)})})}}(middleware);
!function(e){e.fs={},e.fs.add=function(e,n){return new Promise(function(t,r){firebase.firestore().collection(n).add(e).then(function(e){return t(e)})["catch"](function(e){return r(e)})})},e.fs.set=function(e,n,t){return new Promise(function(r,i){firebase.firestore().collection(n).doc(t).set(e).then(function(){return r()})["catch"](function(e){return i(e)})})},e.fs.update=function(e,n,t){return new Promise(function(r,i){firebase.firestore().collection(n).doc(t).update(e).then(function(){return r()})["catch"](function(e){return i(e)})})},e.fs["delete"]=function(e,n){return new Promise(function(t,r){firebase.firestore().collection(e).doc(n)["delete"]().then(function(){return t()})["catch"](function(e){return r(e)})})},e.fs.getCollection=function(e){return new Promise(function(n,t){firebase.firestore().collection(e).get().then(function(e){return n(e)})["catch"](function(e){return t(e)})})},e.fs.getDocument=function(e,n){return new Promise(function(t,r){firebase.firestore().collection(e).doc(n).get().then(function(e){var n=e.data();return n.key=e.id,t(n)})["catch"](function(e){return r(e)})})},e.fs.query=function(e,n,t,r,i){return new Promise(function(o,c){var u,f=[];u=i?firebase.firestore().collection(e).where(n,t,r).limit(i):firebase.firestore().collection(e).where(n,t,r),u.get().then(function(e){return e.forEach(function(e){var n=e.data();n.key=e.id,f.push(n)}),o(f)})["catch"](function(e){return c(e)})})},e.fs.querySortedLimited=function(e,n,t,r,i,o){return new Promise(function(c,u){var f=[];firebase.firestore().collection(e).where(n,t,r).orderBy(i,"desc").limit(o).get().then(function(e){return e.forEach(function(e){var n=e.data();n.key=e.id,f.push(n)}),c(f)})["catch"](function(e){return u(e)})})},e.fs.queryMultipleLimited=function(e,n,t,r,i){return new Promise(function(o,c){var u=[],f=firebase.firestore().collection(e);for(var s in n)f=f.where(n[s],t[s],r[s]);f.limit(i).get().then(function(e){return e.forEach(function(e){var n=e.data();n.key=e.id,u.push(n)}),o(u)})["catch"](function(e){return c(e)})})}}(middleware);
var app=angular.module("autotest",["ngRoute","ngSanitize"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"views/home.html",controller:"home"}).when("/autotest",{templateUrl:"views/autotest.html",controller:"autotest",resolve:{check:["$rootScope","$location",function(e,t){e.testAllowed?t.path("/autotest"):t.path("/")}]}}).when("/about",{templateUrl:"views/about.html"}).when("/contact_us",{templateUrl:"views/contact_us.html"})}]).filter("trusted",["$sce",function(e){return e.trustAsResourceUrl}]).run(["$rootScope",function(e){var t=new Framework7({root:"#app",name:"Autotest COVID19 UNS",id:"com.autotest-covid-uns.test",angular:!0});e.showPreloader=function(o){e.preloader=t.dialog.preloader(o,"blue")},e.hidePreloader=function(){e.preloader.opened&&e.preloader.close()},e.closePanel=function(){t.panel.close(document.getElementById("panel-menu"),!0)},e.showDialog=function(e,o,a){t.dialog.create({title:e,text:o,buttons:a,destroyOnClose:!0}).open()},e.toastSuccess=function(e,o,a){t.toast.create({text:e,position:a||"bottom",closeTimeout:o||2e3,destroyOnClose:!0,cssClass:"toast-success"}).open()},e.toastError=function(e,o,a){t.toast.create({text:e,position:a||"bottom",closeTimeout:o||2e3,destroyOnClose:!0,cssClass:"toast-error"}).open()},e.userAllowed=!1,e.testAllowed=!1,e.firstTest=!1,e.showPreloader("Cargando..."),middleware.init().then(function(t){console.log(t),e.config=t,e.hidePreloader(),e.logData={},e.showPreloader("Determinando ubicación..."),middleware.checkLocation(e.config).then(function(t){e.hidePreloader(),e.logData.lat=t.lat,e.logData.lng=t.lng,e.userAllowed=!0,e.toastSuccess("Su ubicación pertenece al área de estudio."),e.$apply()})["catch"](function(t){console.log(t),e.hidePreloader(),e.toastError("Su ubicación está fuera del área de estudio."),e.$apply()})})["catch"](function(e){console.log(e)})}]);
app.controller("home",["$scope","$rootScope",function(e,t){t.testAllowed=!1;var a=localStorage.getItem("userData");console.log(a),a?e.userData=JSON.parse(a):e.userData={},e.resetCheck=function(){t.testAllowed=!1},e.checkForm=function(){if(!t.testAllowed){if(!e.userData)return void t.toastError("Debe completar su nombre");if(!e.userData.name)return void t.toastError("Debe completar su nombre");if(!e.userData.age)return void t.toastError("Por favor, indique su edad");if(!e.userData.dni)return void t.toastError("Debe completar su DNI");if(e.userData.dni<1e5)return void t.toastError("Su DNI no parece un número válido");if(!e.userData.tel)return void t.toastError("Por favor, indique un teléfono");if(!e.userData.gender)return void t.toastError("Debe indicar su género");localStorage.setItem("userData",JSON.stringify(e.userData));var a=function(){for(var a in e.userData)e.logData[a]=e.userData[a];t.testAllowed=!0,t.toastSuccess("Habilitado para iniciar el autotest",1500,"center"),t.$apply()};t.showPreloader("Verificando datos..."),middleware.fs.query("results","dni","==",e.userData.dni,3).then(function(e){t.hidePreloader();var r={max:3,elapsed:864e5};if(t.config&&t.config.logLimit&&(r={max:t.config.logLimit.max,elapsed:t.config.logLimit.elapsed}),e.length>=r.max)t.showDialog("Límite de resultados","El DNI indicado ya alcanzó el límite de "+r.max+" autotests diferentes.",[{text:"Aceptar"}]);else if(0==e.length)t.firstTest=!0,a();else{var o=0;for(var i in e)e[i].timestamp>o&&(o=e[i].timestamp);Date.now()-o<r.elapsed?t.showDialog("Límite de resultados","Debe transcurrir "+Math.round(t.config.logLimit.elapsed/36e5)+"hs. desde la última vez que realizó el autotest para realizar uno nuevo.",[{text:"Aceptar"}]):t.showDialog("Se encontraron registros","El DNI indicado ya registró <b>"+e.length+"</b> resultado/s. Puede realizar un máximo de "+t.config.logLimit.max+".",[{text:"Aceptar",onClick:function(){a()}}])}})["catch"](function(e){console.log(e),t.hidePreloader(),t.$apply()})}}}]);
app.controller("autotest",["$scope","$rootScope",function(e,t){t.showPreloader("Obteniendo datos..."),t.logData.actionStack=[],middleware.getTree().then(function(a){t.hidePreloader(),e.tree=a.tree,e.current=a.tree[0],t.logData.treeID=a.id,t.logData.actionStack.push({index:"0",timestamp:Date.now()}),t.$apply()})["catch"](function(e){console.log(e)}),e.loadMenu=function(a,r){r&&(t.logData.exitCode=r),-1==a?e.endTest():e.tree[a]&&(t.logData.actionStack.push({index:a,timestamp:Date.now()}),e.current=e.tree[a])},e.endTest=function(){if(t.logData.timestamp=Date.now(),t.showPreloader("Enviando resultados..."),t.firstTest){var a=t.logData.age,r={};r["range_"+(a-a%10)/10]=firebase.firestore.FieldValue.increment(1),middleware.fs.update(r,"stats","ages");var o={};o[t.logData.gender]=firebase.firestore.FieldValue.increment(1),middleware.fs.update(o,"stats","genders")}var n={};n[t.logData.exitCode]=firebase.firestore.FieldValue.increment(1),middleware.fs.update(n,"stats","exitCodes");for(var i={},s="P_0",d=1;d<t.logData.actionStack.length;d++)s+="_"+t.logData.actionStack[d].index,i[s]=firebase.firestore.FieldValue.increment(1),s="P_"+t.logData.actionStack[d].index;middleware.fs.update(i,"pathStats",t.logData.treeID),middleware.fs.add(t.logData,"results").then(function(){e.current={header:"Gracias por completar el test",content:"Si desea actualizar sus respuestas, puede repetir el test dentro de "+Math.round(t.config.logLimit.elapsed/36e5)+" horas.",options:[{text:"Menú principal",href:"#!/"}]},t.hidePreloader(),e.$apply()})["catch"](function(a){console.log(a),e.current={header:"El resultado no pudo registrarse",content:"Hemos enviado datos del problema para tabajar en la solución. Vuelva a intentarlo más tarde.",options:[{text:"Menú principal",href:"#!/"}]};var r={errMsg:JSON.stringify(a),timestamp:Date.now(),origin:"autotest.js/$scope.endTest"};middleware.fs.add(r,"errorLogs").then(function(){t.hidePreloader(),e.$apply()})["catch"](function(a){console.log(a),t.hidePreloader(),e.$apply()})})}}]);
//# sourceMappingURL=maps/main-ef7e7ca508.js.map