window.middleware=function(){var e={apiKey:"AIzaSyDcBhhiu-dQXWaGBLcTEtnz8HPnelfXuA4",authDomain:"covid19-autotest.firebaseapp.com",databaseURL:"https://covid19-autotest.firebaseio.com",projectId:"covid19-autotest",storageBucket:"covid19-autotest.appspot.com",messagingSenderId:"541298094681",appId:"1:541298094681:web:a715a3322843f6ff7e7748",measurementId:"G-0YZX1RVB1F"},t={};return t.init=function(){return new Promise(function(a,i){try{return firebase.initializeApp(e),firebase.auth().onAuthStateChanged(function(e){e?t.users.onUserSignedIn(e.uid):t.users.onUserSignedOut()}),a()}catch(n){return i(n)}})},t}();
!function(e){e.users={},e.users.onUserSignedIn=function(e){console.log("default -- logged in "+e)},e.users.onUserSignedOut=function(){console.log("default -- logged out")},e.users.signIn=function(e){return new Promise(function(n,a){firebase.auth().signInWithEmailAndPassword(e.email,e.password)["catch"](function(e){var n,t=e.code;switch(t){case"auth/wrong-password":n="La contraseña es incorrecta.";break;case"auth/user-disabled":n="El usuario se haya inhabilitado momentáneamente.";break;case"auth/invalid-email":n="El email no es válido. Quizá esté mal escrito o no exista.";break;case"auth/user-not-found":n="El usuario no existe.";break;default:n="Algo pasó.. revisa tu conexión a internet e intentálo nuevamente."}return a([t,n])}).then(function(e){return n("Logeado correctamente.")})})},e.users.signOut=function(){return new Promise(function(e,n){firebase.auth().signOut().then(function(){return e("Ha salido de la aplicación.")})["catch"](function(e){return n([e,"Algo pasó.. intentálo nuevamente."])})})},e.users.signUp=function(e){return new Promise(function(n,a){firebase.auth().createUserWithEmailAndPassword(e.email,e.password)["catch"](function(e){var n,t=e.code;switch(t){case"auth/weak-password":n="La contraseña es demasiado débil. Intenta con una más segura.";break;case"auth/email-already-in-use":n="Éste email ya existe en nuestra base de datos.";break;case"auth/invalid-email":n="El email no es válido. Revisa lo ingresado.";break;case"auth/operation-not-allowed":n="No se puede crear la cuenta para ese usuario. Ponete en contacto con los administradores.";break;default:n="Algo pasó... revisa tu conexión a internet e intentálo nuevamente."}return a([t,n])}).then(function(e){fullfill(e)})})},e.users.resetPwd=function(e){return new Promise(function(n,a){firebase.auth().sendPasswordResetEmail(e).then(function(){return n("Listo. Revisa tu correo electrónico.")})["catch"](function(e){return a([e,"Algo pasó.. intentálo nuevamente."])})})}}(middleware);
!function(n){n.db={},n.db.listen=function(n,e,t){firebase.database().ref(n).on("value",function(n){e(n.val(),n.key)},function(n){t(n)})},n.db.listenChild=function(n,e,t,r,u){firebase.database().ref(n).orderByChild(e).equalTo(t).on("child_added",function(n){r(n.val(),n.key)},function(n){u(n)})},n.db.stopListener=function(n){return new Promise(function(e,t){firebase.database().ref(n).off().then(function(){return e()})["catch"](function(n){return t(n)})})},n.db.get=function(n){return new Promise(function(e,t){firebase.database().ref(n).once("value").then(function(n){return e(n.val())})["catch"](function(n){return t(n)})})},n.db.getSorted=function(n,e){return new Promise(function(t,r){firebase.database().ref(n).orderByChild(e).once("value").then(function(n){return t(n)})["catch"](function(n){return r(n)})})},n.db.getSortedLimited=function(n,e,t){return new Promise(function(r,u){firebase.database().ref(n).orderByChild(e).limitToLast(t).once("value").then(function(n){return r(n)})["catch"](function(n){return u(n)})})},n.db.query=function(n,e,t){return new Promise(function(r,u){firebase.database().ref(n).orderByChild(e).equalTo(t).once("value").then(function(n){return r(n)})["catch"](function(n){return u(n)})})},n.db.set=function(n,e){return new Promise(function(t,r){firebase.database().ref(e).set(n).then(function(n){return t(n)})["catch"](function(n){return r(n)})})},n.db.update=function(n,e){return new Promise(function(t,r){firebase.database().ref(e).update(n).then(function(n){return t(n)})["catch"](function(n){return r(n)})})},n.db.push=function(n,e){return new Promise(function(t,r){firebase.database().ref(e).push(n).then(function(n){return t(n)})["catch"](function(n){return r(n)})})},n.db.pushMultiple=function(n,e){return new Promise(function(t,r){var u=[];for(var i in n)u.push(firebase.database().ref(e).push(n[i]));Promise.all(u).then(function(n){return t(n)})["catch"](function(n){return r(n)})})}}(middleware);
!function(e){e.fs={},e.fs.add=function(e,n){return new Promise(function(t,r){firebase.firestore().collection(n).add(e).then(function(e){return t(e)})["catch"](function(e){return r(e)})})},e.fs.set=function(e,n,t){return new Promise(function(r,i){firebase.firestore().collection(n).doc(t).set(e).then(function(){return r()})["catch"](function(e){return i(e)})})},e.fs.update=function(e,n,t){return new Promise(function(r,i){firebase.firestore().collection(n).doc(t).update(e).then(function(){return r()})["catch"](function(e){return i(e)})})},e.fs["delete"]=function(e,n){return new Promise(function(t,r){firebase.firestore().collection(e).doc(n)["delete"]().then(function(){return t()})["catch"](function(e){return r(e)})})},e.fs.getCollection=function(e){return new Promise(function(n,t){firebase.firestore().collection(e).get().then(function(e){return n(e)})["catch"](function(e){return t(e)})})},e.fs.getDocument=function(e,n){return new Promise(function(t,r){firebase.firestore().collection(e).doc(n).get().then(function(e){var n=e.data();return n.key=e.id,t(n)})["catch"](function(e){return r(e)})})},e.fs.query=function(e,n,t,r,i){return new Promise(function(o,c){var u,f=[];u=i?firebase.firestore().collection(e).where(n,t,r).limit(i):firebase.firestore().collection(e).where(n,t,r),u.get().then(function(e){return e.forEach(function(e){var n=e.data();n.key=e.id,f.push(n)}),o(f)})["catch"](function(e){return c(e)})})},e.fs.querySortedLimited=function(e,n,t,r,i,o){return new Promise(function(c,u){var f=[];firebase.firestore().collection(e).where(n,t,r).orderBy(i,"desc").limit(o).get().then(function(e){return e.forEach(function(e){var n=e.data();n.key=e.id,f.push(n)}),c(f)})["catch"](function(e){return u(e)})})},e.fs.queryMultipleLimited=function(e,n,t,r,i){return new Promise(function(o,c){var u=[],f=firebase.firestore().collection(e);for(var s in n)f=f.where(n[s],t[s],r[s]);f.limit(i).get().then(function(e){return e.forEach(function(e){var n=e.data();n.key=e.id,u.push(n)}),o(u)})["catch"](function(e){return c(e)})})}}(middleware);
var app=angular.module("autotest-admin",["ngRoute","ngSanitize"]).run(["$rootScope","$location",function(e,a){e.userLogged=!1,e.loading=!0,middleware.init(),a.path("/login"),middleware.users.onUserSignedIn=function(o){middleware.db.get("config").then(function(o){e.config=o,e.config.trees=[],middleware.db.getSorted("decisionTrees","timestamp").then(function(o){o.forEach(function(a){var o=a.val();o.key=a.key,o.editable=!1,e.config.trees.push(o)}),e.userLogged=!0,e.loading=!1,a.path("/"),e.$apply()})["catch"](function(a){console.log(a),toastr.error("Ocurrió un error al descargar la configuración global."),e.loading=!1,$scope.$apply()})})["catch"](function(a){console.log(a),toastr.error("Ocurrió un error al descargar la configuración global."),e.loading=!1,$scope.$apply()})},middleware.users.onUserSignedOut=function(){e.userLogged=!1,e.loading=!1,a.path("/login"),e.$apply()},e.logout=function(){e.loading=!0,middleware.users.signOut()},e.getTime=function(e,a){var o;switch(a||(a=3),e||(a=1),a){case 0:o=Date.now();break;case 1:o=moment(Date.now()).format("DD/MM/YYYY HH:mm");break;case 2:o=moment(Date.now()).format("DD/MM/YYYY");break;case 3:o=moment(e).format("DD/MM/YYYY HH:mm");break;case 4:o=moment(e).format("DD/MM/YYYY");break;case 5:o=moment(e).fromNow();break;case 6:o=moment(e).format("DD/MM HH:mm");break;default:o=null}return o},e.html2Text=function(e){var a=document.createElement("div");return a.innerHTML=e,a.textContent||a.innerText||""},e.showHelp=function(a){switch(a){case"main-config":e.helpContent='<p>Configure los parámetros de funcionamiento de la aplicación y presione "Guardar" para que la configuración tome efecto o "Descartar" para reestablecer los cambios a los valores activos.</p>';break;case"map":e.helpContent="<p>El mapa muestra el area de interés. Para modificar esta zona, pulse sobre el mapa y luego indique el radio del área.</p>";break;case"log-limit":e.helpContent="<p>Configure la cantidad de veces que un mismo usuario puede realizar el autotest y el tiempo que debe transcurrir entre cada resultado registrado en la base de datos</p>";break;case"tree-list":e.helpContent="<p>La lista muestra todos los árboles de decisión que fueron creados. Sólo un árbol por vez puede estar activo y una vez que se cargan los árboles a la base de datos ya no pueden volver a ser modificados.</p><p>Los nuevos árboles creados pueden modificarse múltiples veces antes de guardar la configuración global de este menú.</p>";break;case"ages-plot":e.helpContent="<p>El gráfico de barras muestra un histograma de edades de los usuarios. Sólo se contabiliza la edad luego del registro del primer resultado.</p>";break;case"genders-plot":e.helpContent="<p>El gráfico circular muestra la proporción de usuarios por género. Sólo se contabiliza el género seleccionado luego del registro del primer resultado.</p>";break;case"exitCodes-plot":e.helpContent="<p>Cada opción de cada nodo del árbol de decisiones puede tener asociado un código de salida. Cada vez que el usuario selecciona dicha opción del menú, se contabiliza el código de salida correspondiente. El significado de cada código de salida es definido por el administrador en al momento de diseñar el árbol de decisiones.</p>";break;case"paths-plot":e.helpContent="<p>El gráfico permite visualizar el árbol de decisiones actual donde el espesor de cada camino es proporcional a la cantidad de veces que un usuario pasó por ese camino.</p>";break;case"tree-container":e.helpContent="<p>El gráfico permite visualizar el árbol de decisiones activo. Puede arrastrar los nodos, desplazar la vista o hacer zoom.</p>";break;default:e.helpContent="No se encontro la referencia"}$("#help-modal").modal("show")}}]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"views/dashboard.html",controller:"dashboard"}).when("/login",{templateUrl:"views/login.html",controller:"login"}).when("/config",{templateUrl:"views/config.html",controller:"config"})}]).filter("trusted",["$sce",function(e){return e.trustAsResourceUrl}]);
app.controller("login",["$scope","$rootScope",function(o,r){o.login=function(){return o.form?o.form.email?o.form.password?(r.loading=!0,void middleware.users.signIn(o.form).then(function(o){toastr.success("Bienvenido!")})["catch"](function(e){console.log(e),toastr.error(e[1]),r.loading=!1,o.$apply()})):void toastr.error("Ingrese su contraseña!"):void toastr.error("Indique su usuario!"):void toastr.error("Complete los campos de credenciales!")},o.retrievePassword=function(){toastr.info("Pronto contaremos con esa funcionalidad.")}}]);
app.controller("dashboard",["$scope","$rootScope","$location",function(t,a,e){a.userLogged||e.path("/login");var o=function(){var e=[],o=[],n=[],s=Math.floor(200/Object.getOwnPropertyNames(a.stats.ages).length),r=5;for(var i in a.stats.ages){var d=10*parseInt(i.split("_")[1]),l=d+9;e.push(d+"-"+l),o.push(a.stats.ages[i]),n.push("rgba("+r+","+r+","+r+",0.9)"),r+=s}t.agesChart&&t.agesChart.destroy(),t.agesChart=new Chart(document.getElementById("age-chart"),{type:"bar",data:{labels:e,datasets:[{label:"Usuarios por edad",backgroundColor:n,data:o}]},options:{maintainAspectRatio:!1}})},n=function(){t.genderChart&&t.genderChart.destroy(),t.genderChart=new Chart(document.getElementById("gender-chart"),{type:"doughnut",data:{labels:["Masculino","Femenino","Otro"],datasets:[{backgroundColor:["#333333","#777777","#AAAAAA"],pointRadius:0,data:[a.stats.genders.m,a.stats.genders.f,a.stats.genders.n]}]},options:{maintainAspectRatio:!0}})},s=function(){t.exitCodeChart&&t.exitCodeChart.destroy(),t.exitCodeChart=new Chart(document.getElementById("exitCode-chart"),{type:"bar",data:{labels:["S001","S002"],datasets:[{label:"Código de resultado",backgroundColor:["#333333","#777777"],data:[120,12]}]},options:{maintainAspectRatio:!0}})},r=function(){var t=a.config.trees.find(function(t){return t.active}),e=t.tree,o={},n=0;for(var s in a.pathStats[t.id])o[s.split("_")[1]]||(o[s.split("_")[1]]={}),o[s.split("_")[1]][s.split("_")[2]]=a.pathStats[t.id][s],a.pathStats[t.id][s]>n&&(n=a.pathStats[t.id][s]);console.log(o);var r=[],i=[];for(var s in e){var d=e[s].header.substring(0,15)+"-\n"+e[s].header.substring(15,30)+"-\n"+e[s].header.substring(30,50);r.push({id:s,value:1,label:"["+s+"] -- "+a.html2Text(d)+"...",shape:"box",font:{size:12,color:"white",face:"arial"},color:"#444444"});for(var l in e[s].options)-1!=e[s].options[l]["goto"]&&void 0!=e[s].options[l]["goto"]&&i.push({from:s,to:e[s].options[l]["goto"],smooth:{type:"curvedCW",roundness:Math.random()-.5},value:Math.round(o[s][e[s].options[l]["goto"]]/n*10)||1,label:a.html2Text(e[s].options[l].text).substring(0,10)+(e[s].options[l].text.length>10?"...":"")+"\n("+o[s][e[s].options[l]["goto"]]+")"})}var c={nodes:new vis.DataSet(r),edges:new vis.DataSet(i)};console.log(c);var p={layout:{hierarchical:{direction:"UD",sortMethod:"directed"}},physics:!1,edges:{font:{size:10,color:"black",face:"arial",align:"top"},arrows:{to:{enabled:!0,scaleFactor:1}}},nodes:{shape:"box"}};new vis.Network(document.getElementById("paths-container"),c,p)};t.updateStats=function(){a.loading=!0,middleware.fs.getCollection("stats").then(function(e){a.stats={},e.forEach(function(t){a.stats[t.id]=t.data()}),o(),s(),n(),middleware.fs.getCollection("pathStats").then(function(e){a.pathStats={},e.forEach(function(t){a.pathStats[t.id]=t.data()}),r(),a.loading=!1,t.$apply()})["catch"](function(e){console.log(e),a.loading=!1,t.$apply()})})["catch"](function(e){console.log(e),a.loading=!1,t.$apply()})},a.stats?(o(),s(),n(),r()):t.updateStats()}]);
app.controller("config",["$scope","$rootScope",function(o,e){e.userLogged||$location.path("/login"),o.map=L.map("map").fitWorld(),L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",{maxZoom:18,id:"mapbox/streets-v11",accessToken:"pk.eyJ1IjoibWF0aWFzbWljaGVsZXR0byIsImEiOiJjazVsa2ZtamowZHJnM2ttaXFmZGo1MDhtIn0.8iBO-J1wj34LIqq-e4Me5w"}).addTo(o.map),o.map.on("click",function(e){console.log(e.latlng),o.newLocation=e.latlng,o.newLocation.range=o.tempConfig.locationFilter.range,o.$apply(),$("#location-modal").modal("show")}),o.map.on("locationfound",function(e){console.log(e),console.log(o.tempConfig)}),o.map.locate({setView:!0,maxZoom:16});var a=function(){var e={marker:L.marker(o.tempConfig.locationFilter),radius:L.circle(o.tempConfig.locationFilter,1e3*o.tempConfig.locationFilter.range)};o.markerGroup&&o.markerGroup.clearLayers(),o.markerGroup=L.layerGroup().addTo(o.map),e.marker.addTo(o.markerGroup).bindPopup("Area de acceso a la aplicación"),e.radius.addTo(o.markerGroup),e.marker.openPopup()};o.updateLocationFilter=function(){o.tempConfig.locationFilter=angular.copy(o.newLocation),a(),toastr.success("Espacio de operación actualizado"),$("#location-modal").modal("hide")};var t=function(){var a=o.tempConfig.trees.find(function(o){return o.active}),t=a.tree,n=[],i=[];for(var r in t){var s=t[r].header.substring(0,15)+"-\n"+t[r].header.substring(15,30)+"-\n"+t[r].header.substring(30,50);n.push({id:r,value:1,label:"["+r+"] -- "+e.html2Text(s)+"...",shape:"box",font:{size:12,color:"white",face:"arial"},color:"#444444"});for(var l in t[r].options)t[r].options[l]["goto"]&&i.push({from:r,to:t[r].options[l]["goto"],smooth:{type:"curvedCW",roundness:Math.random()-.5},label:e.html2Text(t[r].options[l].text).substring(0,10)+(t[r].options[l].text.length>10?"...":"")})}var c={nodes:n,edges:i};console.log(c);var p={layout:{hierarchical:{direction:"UD",sortMethod:"directed"}},physics:!1,edges:{font:{size:10,color:"black",face:"arial",align:"top"},arrows:{to:{enabled:!0,scaleFactor:1}}},nodes:{shape:"box"}};new vis.Network(document.getElementById("tree-container"),c,p)};o.newTree=function(){toastr.success("Nuevo arbol creado");var e={author:firebase.auth().currentUser.email,id:"T00"+(o.tempConfig.trees.length+1),timestamp:Date.now(),editable:!0,tree:[]};o.tempConfig.trees.push(e)},o.setActiveTree=function(o){toastr.info("Aún no es posible modificar árboles activos")},o.editTree=function(e){o.editingTree=angular.copy(o.tempConfig.trees[e]),console.log(o.editingTree),$("#tree-edit-modal").modal("show")},o.saveConfig=function(){toastr.info("Aún no es posible cargar la configuración actual a la base de datos."),e.config=angular.copy(o.tempConfig);for(var a in e.config.trees)delete e.config.trees.editable;console.log("Actualizar config"),console.log(e.config)},o.resetConfig=function(){o.tempConfig=angular.copy(e.config),o.elapsedHours=o.tempConfig.logLimit.elapsed/36e5,a(),t()},o.updateElapsed=function(){o.tempConfig.logLimit.elapsed=36e5*o.elapsedHours},o.resetConfig()}]);
//# sourceMappingURL=maps/main-1b030f2010.js.map